<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>SQL Playground</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap"
      rel="stylesheet"
    />

    <!-- CodeMirror for the SQL editor -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material-darker.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/sql/sql.min.js"></script>

    <!-- Syntax Highlighter for examples page -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #1a1a1a;
        color: #e0e0e0;
        overflow: hidden;
      }
  :root { --mobile-nav-height: 56px; }
      .CodeMirror {
        font-family: "Fira Code", monospace;
        font-size: 14px;
        line-height: 21px;
        height: 100%;
        background-color: #1e1e1e;
      }
      .CodeMirror-gutters {
        background-color: #1e1e1e !important;
        border-right: 1px solid #3a3a3a;
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #2d2d2d;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #555;
        border-radius: 4px;
      }
      .resizer {
        background-color: #3a3a3a;
        cursor: col-resize;
        width: 5px;
        height: 100%;
        z-index: 10;
      }
      .mobile-nav-btn.active,
      .header-tab.active {
        color: #22c55e;
        border-bottom-color: #22c55e;
      }
      .mobile-nav-btn.active {
        border-top-color: #22c55e;
      }

      /* Responsive Layout Adjustments */
      @media (max-width: 768px) {
        #playground-view {
          flex-direction: column;
        }
        #left-panel,
        #right-panel {
          width: 100%;
          height: 100%;
        }
        .resizer {
          display: none;
        }
  #mobile-nav { display: flex; position: fixed; bottom: 0; left: 0; right: 0; z-index: 50; padding-bottom: env(safe-area-inset-bottom); }

  /* Ensure main views aren't obscured by fixed bottom nav */
  #playground-view, #examples-view { padding-bottom: calc(var(--mobile-nav-height) + env(safe-area-inset-bottom)); }

        #examples-view .max-w-4xl {
          max-width: 100%;
        }
        #examples-view pre {
          overflow-x: auto;
          white-space: pre;
        }
        #examples-view h1 {
          font-size: 1.5rem;
        }
        #examples-view h2 {
          font-size: 1.25rem;
        }
        #examples-view h3 {
          font-size: 1.1rem;
        }
        #examples-view p {
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body class="flex flex-col h-screen">
    <header
      class="bg-[#282828] text-white flex items-center justify-between px-4 flex-shrink-0 border-b border-gray-700"
    >
      <div class="flex items-center gap-6">
        <h1 class="text-xl font-semibold text-gray-300 py-2">SQL Playground</h1>
        <div class="hidden sm:flex items-center gap-4">
          <button
            class="header-tab text-sm font-medium py-3 border-b-2"
            data-view="playground"
          >
            Playground
          </button>
          <button
            class="header-tab text-sm font-medium py-3 border-b-2 border-transparent text-gray-400"
            data-view="examples"
          >
            Examples
          </button>
        </div>
      </div>
      <div id="db-status" class="text-sm flex items-center gap-2">
        <div
          id="status-indicator"
          class="w-3 h-3 rounded-full bg-yellow-500 animate-pulse"
        ></div>
        <span id="status-text">Initializing DB...</span>
      </div>
    </header>

    <div id="playground-view" class="flex flex-grow overflow-hidden">
      <!-- Panels here -->
      <div id="left-panel" class="flex flex-col w-1/2 h-full bg-[#1e1e1e]">
        <div
          class="flex-shrink-0 bg-[#282828] p-2 flex justify-between items-center border-b border-gray-700"
        >
          <h2 class="font-semibold text-gray-200">SQL Editor</h2>
          <button
            id="run-query-btn"
            class="bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-1.5 rounded-md text-sm flex items-center gap-2 disabled:bg-gray-500 disabled:cursor-not-allowed"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              fill="currentColor"
              viewBox="0 0 16 16"
            >
              <path
                d="M10.804 8 5 4.633v6.734L10.804 8zm.792-.696a.802.802 0 0 1 0 1.392l-6.363 3.692C4.713 12.69 4 12.345 4 11.692V4.308c0-.653.713-.998 1.233-.696l6.363 3.692z"
              />
            </svg>
            Run
          </button>
        </div>
        <div class="flex-grow overflow-hidden">
          <textarea id="sql-editor"></textarea>
        </div>
      </div>
      <div id="resizer" class="resizer"></div>
      <div id="right-panel" class="flex flex-col w-1/2 h-full bg-[#252526]">
        <div class="flex-shrink-0 bg-[#282828] p-2 border-b border-gray-700">
          <div class="flex gap-2">
            <button
              id="schema-tab"
              class="schema-tab text-sm px-3 py-1 rounded border-b-2 border-transparent text-gray-400 hover:text-gray-200"
            >
              Schema
            </button>
            <button
              id="visualization-tab"
              class="schema-tab text-sm px-3 py-1 rounded border-b-2 border-transparent text-gray-400 hover:text-gray-200"
            >
              Visualization
            </button>
            <button
              id="output-tab"
              class="schema-tab active text-sm px-3 py-1 rounded border-b-2 border-blue-500 text-blue-400"
            >
              Output
            </button>
          </div>
        </div>
        <div
          id="schema-content"
          class="hidden flex-grow p-4 overflow-y-auto custom-scrollbar"
        >
          <div id="schema-viewer"></div>
        </div>
        <div
          id="visualization-content"
          class="hidden flex-grow p-4 overflow-y-auto custom-scrollbar"
        >
          <div id="database-visualization">
            <div class="mb-4">
              <h3 class="text-lg font-semibold text-gray-200 mb-2">
                Database Schema Visualization
              </h3>
              <p class="text-gray-400 text-sm">
                Visual representation of table relationships and structure.
              </p>
            </div>
            <div
              id="schema-diagram"
              class="bg-gray-800 rounded-lg p-4 min-h-[400px]"
            ></div>
          </div>
        </div>
        <div
          id="output-content"
          class="flex-grow p-4 overflow-y-auto custom-scrollbar"
        >
          <div class="flex-grow h-full flex flex-col">
            <div
              class="flex-shrink-0 bg-[#282828] p-2 border-b border-gray-700 mb-4"
            >
              <h2 class="font-semibold text-gray-200">Query Results</h2>
            </div>
            <div
              id="results-container"
              class="flex-grow overflow-auto custom-scrollbar"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <div
      id="examples-view"
      class="hidden flex-grow overflow-y-auto custom-scrollbar p-6 sm:p-8"
    >
      <div class="max-w-[1400px] mx-auto pb-16">
        <h1 class="text-4xl font-bold mb-6 text-gray-100">
          DuckDB SQL Playground
        </h1>

        <div class="grid grid-cols-12 gap-6">
          <!-- Global sticky sidenav for all examples view -->
          <aside id="examples-sidenav" class="col-span-12 lg:col-span-3 bg-gray-800/60 border border-gray-700 rounded-lg h-fit lg:sticky lg:top-4 self-start">
            <div class="p-4 border-b border-gray-700 text-sm text-gray-300 bg-gray-800">Navigation</div>
            <nav id="examples-sidenav-list" class="max-h-[70vh] overflow-y-auto custom-scrollbar divide-y divide-gray-700">
              <div class="p-4">
                <div class="text-xs uppercase tracking-wider text-gray-400 mb-2">Sections</div>
                <ul class="space-y-1 text-sm" id="examples-primary-nav">
                  <li><button class="ex-nav-btn text-left w-full px-2 py-1 rounded text-gray-200 hover:bg-gray-700" data-section="getting-started">Getting Started</button></li>
                  <li><button class="ex-nav-btn text-left w-full px-2 py-1 rounded text-gray-300 hover:bg-gray-700" data-section="understanding-db">Understanding DB</button></li>
                  <li><button class="ex-nav-btn text-left w-full px-2 py-1 rounded text-gray-300 hover:bg-gray-700" data-section="sql-reference">SQL Reference</button></li>
                  <li><button class="ex-nav-btn text-left w-full px-2 py-1 rounded text-gray-300 hover:bg-gray-700" data-section="lessons">Lessons</button></li>
                </ul>
              </div>
              <div class="p-4 border-t border-gray-700">
                <div class="text-xs uppercase tracking-wider text-gray-400 mb-2">Lessons</div>
                <div id="lesson-nav-groups" class="space-y-1">
                  <div class="text-gray-400 text-sm">Loading lessons…</div>
                </div>
              </div>
            </nav>
          </aside>

          <!-- Main content area (single container) -->
          <main id="examples-main" class="col-span-12 lg:col-span-9"></main>

          <!-- Templates for main content sections -->
          <template id="tmpl-getting-started">
            <section class="mb-8">
              <h2 class="text-3xl font-semibold border-b border-gray-600 pb-2 mb-4 text-blue-300">Getting Started</h2>
              <p class="text-gray-300 mb-4 text-base">Welcome to your interactive SQL playground powered by DuckDB WebAssembly! This environment runs entirely in your browser with no server required. Start experimenting with the sample data below or create your own tables.</p>
              <div class="bg-blue-900/30 border border-blue-700 rounded-lg p-4 mb-4">
                <h3 class="text-blue-300 font-semibold mb-2 text-lg">💡 Quick Start Tips</h3>
                <ul class="text-blue-200 text-base space-y-1">
                  <li>• Click any example to copy it to the editor</li>
                  <li>• Use Ctrl+Enter (Cmd+Enter on Mac) to run queries</li>
                  <li>• Watch the Schema Viewer update as you create tables</li>
                  <li>• Try the progressive examples below to learn SQL concepts</li>
                </ul>
              </div>
            </section>
          </template>

          <template id="tmpl-understanding-db">
            <section class="mb-8">
              <h2 class="text-3xl font-semibold border-b border-gray-600 pb-2 mb-4 text-purple-300">Understanding Relational Databases</h2>
              <p class="text-gray-300 mb-4 text-base">SQL databases organize data in <strong>tables</strong> with rows and columns. Tables can be related through <strong>foreign keys</strong>, enabling complex data relationships while maintaining consistency.</p>
              <div class="grid md:grid-cols-2 gap-6 mb-6">
                <div class="bg-gray-800 p-4 rounded-lg">
                  <h3 class="text-purple-300 font-semibold mb-2 text-lg">Key Concepts</h3>
                  <ul class="text-gray-300 text-base space-y-1">
                    <li><strong>Table:</strong> Collection of related data in rows and columns</li>
                    <li><strong>Primary Key:</strong> Uniquely identifies each row</li>
                    <li><strong>Foreign Key:</strong> Links to primary key in another table</li>
                    <li><strong>Schema:</strong> Structure defining table relationships</li>
                    <li><strong>ACID:</strong> Atomicity, Consistency, Isolation, Durability</li>
                  </ul>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                  <h3 class="text-purple-300 font-semibold mb-2 text-lg">DuckDB Advantages</h3>
                  <ul class="text-gray-300 text-base space-y-1">
                    <li><strong>In-Process:</strong> No separate server needed</li>
                    <li><strong>Analytics-First:</strong> Optimized for analytical queries</li>
                    <li><strong>SQL Standard:</strong> Full SQL support with extensions</li>
                    <li><strong>Zero-Copy:</strong> Efficient data processing</li>
                    <li><strong>Embeddable:</strong> Works in browsers and applications</li>
                  </ul>
                </div>
              </div>
            </section>
          </template>

          <template id="tmpl-sql-reference">
            <section class="mb-8">
              <h2 class="text-3xl font-semibold border-b border-gray-600 pb-2 mb-4 text-blue-300">SQL Fundamentals Reference</h2>
              <p class="text-gray-300 mb-4 text-base">Quick reference for core SQL concepts and DuckDB-specific features.</p>
              <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-gray-800 p-4 rounded-lg">
                  <h3 class="text-blue-300 font-semibold mb-3 text-lg">SQL Execution Order</h3>
                  <ol class="list-decimal list-inside space-y-1 text-base text-gray-300">
                    <li><code class="bg-gray-700 px-2 py-1 rounded">FROM</code> / <code class="bg-gray-700 px-2 py-1 rounded">JOIN</code> - Assemble data</li>
                    <li><code class="bg-gray-700 px-2 py-1 rounded">WHERE</code> - Filter rows</li>
                    <li><code class="bg-gray-700 px-2 py-1 rounded">GROUP BY</code> - Group rows</li>
                    <li><code class="bg-gray-700 px-2 py-1 rounded">HAVING</code> - Filter groups</li>
                    <li><code class="bg-gray-700 px-2 py-1 rounded">SELECT</code> - Choose columns</li>
                    <li><code class="bg-gray-700 px-2 py-1 rounded">DISTINCT</code> - Remove duplicates</li>
                    <li><code class="bg-gray-700 px-2 py-1 rounded">ORDER BY</code> - Sort results</li>
                    <li><code class="bg-gray-700 px-2 py-1 rounded">LIMIT</code> - Restrict rows</li>
                  </ol>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg">
                  <h3 class="text-blue-300 font-semibold mb-3 text-lg">Common Data Types</h3>
                  <div class="space-y-2 text-base">
                    <div><code class="text-blue-400">INTEGER</code> - Whole numbers</div>
                    <div><code class="text-blue-400">VARCHAR</code> - Variable-length text</div>
                    <div><code class="text-blue-400">DECIMAL(p,s)</code> - Fixed-point numbers</div>
                    <div><code class="text-blue-400">BOOLEAN</code> - True/false values</div>
                    <div><code class="text-blue-400">DATE</code> - Date values</div>
                    <div><code class="text-blue-400">TIMESTAMP</code> - Date and time</div>
                    <div><code class="text-blue-400">SERIAL</code> - Auto-incrementing integer</div>
                  </div>
                </div>
              </div>
              <div class="mt-6 bg-blue-900/20 border border-blue-700 rounded-lg p-4">
                <h3 class="text-blue-300 font-semibold mb-2 text-lg">📚 Learn More</h3>
                <p class="text-blue-200 text-base mb-2">This playground covers essential SQL concepts with DuckDB. For advanced features and complete documentation:</p>
                <a href="https://duckdb.org/docs/stable/sql/introduction" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline text-base">→ DuckDB Official Documentation</a>
              </div>
            </section>
          </template>

          <template id="tmpl-lessons">
            <section class="mb-8">
              <h2 class="text-3xl font-semibold border-b border-gray-600 pb-2 mb-4 text-green-300">Lessons</h2>
              <main id="lesson-content" class="bg-gray-900/60 border border-gray-700 rounded-lg p-4 min-h-[300px]">
                <div class="text-gray-400 text-base">Select a lesson from the left to view content.</div>
              </main>
              <div id="lessons-hint" class="mt-3 text-sm text-gray-500 hidden">Tip: If lessons fail to load when opening this file directly from disk, serve this folder with a local HTTP server to allow fetching JSON.</div>
            </section>
          </template>
        </div>

      </div>
    </div>

    <nav
      id="mobile-nav"
      class="hidden bg-[#282828] border-t border-gray-700 w-full flex-shrink-0"
    >
      <button
        class="mobile-nav-btn flex-1 p-3 text-sm text-center font-medium border-t-2"
        data-view="editor"
      >
        Editor
      </button>
      <button
        class="mobile-nav-btn flex-1 p-3 text-sm text-center font-medium border-t-2 border-transparent text-gray-400"
        data-view="output"
      >
        Output
      </button>
      <button
        class="mobile-nav-btn flex-1 p-3 text-sm text-center font-medium border-t-2 border-transparent text-gray-400"
        data-view="schema"
      >
        Schema
      </button>
      <button
        class="mobile-nav-btn flex-1 p-3 text-sm text-center font-medium border-t-2 border-transparent text-gray-400"
        data-view="visualization"
      >
        Viz
      </button>
    </nav>

    <script type="module">
      import * as duckdb from "https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/+esm";

      document.addEventListener("DOMContentLoaded", async () => {
        const editor = CodeMirror.fromTextArea(
          document.getElementById("sql-editor"),
          {
            mode: "text/x-sql",
            theme: "material-darker",
            lineNumbers: true,
            autofocus: true,
            value: `-- Welcome to your SQL Playground!
-- Click 'Examples' to find commands.

CREATE TABLE books (
  id INTEGER,
  title VARCHAR,
  author VARCHAR,
  published_year INTEGER
);

INSERT INTO books VALUES (1, '1984', 'George Orwell', 1949);

SELECT * FROM books;`,
          }
        );

        const runQueryBtn = document.getElementById("run-query-btn");
        const schemaViewer = document.getElementById("schema-viewer");
        const resultsContainer = document.getElementById("results-container");
        const statusIndicator = document.getElementById("status-indicator");
        const statusText = document.getElementById("status-text");
        const playgroundView = document.getElementById("playground-view");
        const examplesView = document.getElementById("examples-view");
        const leftPanel = document.getElementById("left-panel");
        const rightPanel = document.getElementById("right-panel");
        const schemaContent = document.getElementById("schema-content");
        const visualizationContent = document.getElementById(
          "visualization-content"
        );
        const outputContent = document.getElementById("output-content");
        const schemaDiagram = document.getElementById("schema-diagram");

        let db_connection;
        runQueryBtn.disabled = true;

        try {
          const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
          const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);
          const worker_url = URL.createObjectURL(
            new Blob([`importScripts("${bundle.mainWorker}");`], {
              type: "text/javascript",
            })
          );
          const worker = new Worker(worker_url);
          const logger = new duckdb.ConsoleLogger();
          const db = new duckdb.AsyncDuckDB(logger, worker);
          await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
          URL.revokeObjectURL(worker_url);
          db_connection = await db.connect();

          statusIndicator.classList.replace("bg-yellow-500", "bg-green-500");
          statusIndicator.classList.remove("animate-pulse");
          statusText.textContent = "Database Ready";
          runQueryBtn.disabled = false;
        } catch (e) {
          console.error("DuckDB initialization failed:", e);
          statusIndicator.classList.replace("bg-yellow-500", "bg-red-500");
          statusIndicator.classList.remove("animate-pulse");
          statusText.textContent = "DB Failed to Load";
          resultsContainer.innerHTML = `<div class="p-3 text-sm text-red-400 bg-red-900 rounded-md"><strong>Fatal Error:</strong> Could not initialize the in-browser database. ${e.message}</div>`;
        }

        const renderTable = (data, container) => {
          if (!data || data.length === 0) {
            container.innerHTML = `<p class="text-gray-400">Query executed successfully, but returned no rows.</p>`;
            return;
          }
          const headers = Object.keys(data[0]);
          let tableHTML = `<div class="overflow-x-auto custom-scrollbar"><table class="w-full text-sm text-left text-gray-400"><thead class="text-xs text-gray-300 uppercase bg-gray-700"><tr>`;
          headers.forEach(
            (h) =>
              (tableHTML += `<th scope="col" class="px-4 py-2 whitespace-nowrap">${h}</th>`)
          );
          tableHTML += `</tr></thead><tbody>`;
          data.forEach((row) => {
            tableHTML += `<tr class="border-b bg-gray-800 border-gray-700">`;
            headers.forEach((h) => {
              let value = row[h];
              if (typeof value === "bigint") value = value.toString();
              if (value === null) value = "NULL";
              tableHTML += `<td class="px-4 py-2 whitespace-nowrap">${value}</td>`;
            });
            tableHTML += `</tr>`;
          });
          tableHTML += `</tbody></table></div>`;
          container.innerHTML = tableHTML;
        };

  const updateSchemaViewer = async () => {
          if (!db_connection) return;
          try {
            const tablesArrow = await db_connection.query(`SHOW TABLES;`);
            const tables = tablesArrow.toArray().map((row) => row.toJSON());

            if (tables.length === 0) {
              schemaViewer.innerHTML = `<p class="text-gray-500 text-sm">No tables found. Run a 'CREATE TABLE' statement to begin.</p>`;
              updateVisualization([]);
              return;
            }

            let schemaHTML = '<div class="space-y-4">';
            const tableInfo = [];

            for (const table of tables) {
              const tableName = table.name;
              schemaHTML += `<div class="bg-gray-800 p-3 rounded-md">`;
              schemaHTML += `<h3 class="font-semibold text-teal-400 font-mono">${tableName}</h3>`;

              const columnsArrow = await db_connection.query(
                `PRAGMA table_info('${tableName}');`
              );
              const columns = columnsArrow.toArray().map((row) => row.toJSON());

              schemaHTML += `<ul class="text-xs text-gray-400 mt-2 pl-3 space-y-1">`;
              columns.forEach((col) => {
                let badge = "";
                if (col.pk)
                  badge += '<span class="text-yellow-400 text-xs">PK</span> ';
                if (col.notnull)
                  badge +=
                    '<span class="text-blue-400 text-xs">NOT NULL</span> ';
                schemaHTML += `<li><span class="font-mono">${col.name}</span> <span class="text-gray-500">${col.type}</span> ${badge}</li>`;
              });
              schemaHTML += `</ul></div>`;

              tableInfo.push({ name: tableName, columns: columns });
            }
            schemaHTML += "</div>";
            schemaViewer.innerHTML = schemaHTML;
            // Try to read real foreign keys from information_schema; fallback to heuristics
            let relationships = [];
            try {
              const fkArrow = await db_connection.query(`
                SELECT 
                  tc.table_name AS table_name,
                  kcu.column_name AS column_name,
                  ccu.table_name AS foreign_table_name,
                  ccu.column_name AS foreign_column_name
                FROM information_schema.table_constraints AS tc
                JOIN information_schema.key_column_usage AS kcu
                  ON tc.constraint_name = kcu.constraint_name AND tc.table_schema = kcu.table_schema
                JOIN information_schema.constraint_column_usage AS ccu
                  ON ccu.constraint_name = tc.constraint_name AND ccu.table_schema = tc.table_schema
                WHERE tc.constraint_type = 'FOREIGN KEY'
                ORDER BY 1,2;`);
              relationships = fkArrow.toArray().map(r => r.toJSON());
            } catch (e) {
              // ignore; will use heuristics
            }
            if (!relationships || relationships.length === 0) {
              // Heuristic: if column name in table A matches a PK column name in table B
              const pkByTable = new Map();
              tableInfo.forEach(t => {
                pkByTable.set(t.name, new Set(t.columns.filter(c => c.pk).map(c => c.name)));
              });
              const relSet = new Set();
              tableInfo.forEach(a => {
                a.columns.forEach(col => {
                  if (col.pk) return;
                  tableInfo.forEach(b => {
                    if (a.name === b.name) return;
                    const pkset = pkByTable.get(b.name) || new Set();
                    if (pkset.has(col.name)) {
                      const key = `${a.name}|${col.name}|${b.name}|${col.name}`;
                      if (!relSet.has(key)) {
                        relSet.add(key);
                        relationships.push({
                          table_name: a.name,
                          column_name: col.name,
                          foreign_table_name: b.name,
                          foreign_column_name: col.name,
                        });
                      }
                    }
                  });
                });
              });
            }
            updateVisualization(tableInfo, relationships);
          } catch (e) {
            console.error("Failed to update schema:", e);
            schemaViewer.innerHTML = `<p class="text-red-400 text-sm">Error fetching schema.</p>`;
            updateVisualization([], []);
          }
        };

  const updateVisualization = (tableInfo, relationships=[]) => {
          if (tableInfo.length === 0) {
            schemaDiagram.innerHTML = `
                        <div class="flex items-center justify-center h-full text-gray-500">
                            <div class="text-center">
                                <div class="text-4xl mb-4">🗄️</div>
                                <p>No tables to visualize</p>
                                <p class="text-sm mt-2">Create some tables to see the schema diagram</p>
                            </div>
                        </div>
                    `;
            return;
          }

          // Prepare sorted relationships and formatted list HTML for clarity
          const relSorted = Array.isArray(relationships)
            ? relationships.slice().sort((a, b) => {
                const ak = `${a.table_name}.${a.column_name}→${a.foreign_table_name}.${a.foreign_column_name}`;
                const bk = `${b.table_name}.${b.column_name}→${b.foreign_table_name}.${b.foreign_column_name}`;
                return ak.localeCompare(bk);
              })
            : [];
          const relListHtml = (relSorted && relSorted.length > 0)
            ? relSorted
                .map(
                  (r) => `
                    <div class=\"flex items-center gap-2\">
                      <span class=\"text-gray-300\"><code class=\"bg-gray-800/80 px-1 py-0.5 rounded text-gray-200\">${r.table_name}.${r.column_name}</code> → <code class=\"bg-gray-800/80 px-1 py-0.5 rounded text-gray-200\">${r.foreign_table_name}.${r.foreign_column_name}</code></span>
                    </div>`
                )
                .join("")
            : '<div class="text-gray-400">No relationships detected</div>';

          let diagramHTML = `
                    <div class="space-y-6">
                        <div class="text-center mb-6">
                            <h4 class="text-lg font-semibold text-gray-200">Database Schema</h4>
                            <p class="text-sm text-gray-400">Tables: ${tableInfo.length}</p>
                        </div>
                `;

          // Create visual representation of tables
          tableInfo.forEach((table, index) => {
            const isEven = index % 2 === 0;
            diagramHTML += `
                        <div class="bg-gray-700 rounded-lg p-4 border-l-4 ${getTableColor(
                          table.name
                        )}" style="margin-left: ${isEven ? "0" : "40px"}">
                            <div class="flex items-center mb-2">
                                <div class="w-3 h-3 ${getTableIconColor(
                                  table.name
                                )} rounded-full mr-2"></div>
                                <h4 class="font-bold text-gray-100 font-mono">${
                                  table.name
                                }</h4>
                            </div>
                            <div class="grid gap-1">
                    `;

            table.columns.forEach((col) => {
              let typeColor = "text-blue-300";
              if (col.type.includes("INTEGER") || col.type.includes("SERIAL"))
                typeColor = "text-green-300";
              else if (
                col.type.includes("VARCHAR") ||
                col.type.includes("TEXT")
              )
                typeColor = "text-yellow-300";
              else if (col.type.includes("DECIMAL"))
                typeColor = "text-purple-300";
              else if (
                col.type.includes("DATE") ||
                col.type.includes("TIMESTAMP")
              )
                typeColor = "text-pink-300";
              const isFk = relationships.some(r => r.table_name === table.name && r.column_name === col.name);
              diagramHTML += `
                            <div class="flex justify-between items-center text-sm py-1 px-2 rounded ${
                              col.pk ? "bg-yellow-900/30" : ""
                            }">
                                <span class="font-mono text-gray-200">${
                                  col.name
                                }</span>
                                <div class="flex items-center gap-2">
                                    <span class="${typeColor} text-xs">${
                col.type
              }</span>
                                    ${
                                      col.pk
                                        ? '<span class="bg-yellow-600 text-yellow-100 px-1 rounded text-xs">PK</span>'
                                        : ""
                                    }
                                    ${ isFk ? '<span class="bg-blue-600 text-blue-100 px-1 rounded text-xs">FK</span>' : '' }
                                </div>
                            </div>
                        `;
            });

            diagramHTML += `
                            </div>
                        </div>
                    `;
          });

          // Add relationship indicators dynamically
          diagramHTML += `
                    <div class="mt-6 p-4 bg-gray-700 rounded-lg">
                        <h5 class="font-semibold text-gray-200 mb-3">Relationships</h5>
                        <div class="space-y-2 text-sm">
                          ${relListHtml}
                        </div>
                    </div>
                    
                    <div class="mt-4 p-4 bg-gray-700 rounded-lg">
                        <h5 class="font-semibold text-gray-200 mb-3">🔍 Schema Insights</h5>
                        <div class="grid md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <div class="font-medium text-gray-300">Tables: ${
                                  tableInfo.length
                                }</div>
                                <div class="text-gray-400">Total columns: ${tableInfo.reduce(
                                  (sum, table) => sum + table.columns.length,
                                  0
                                )}</div>
                            </div>
                            <div>
                                <div class="font-medium text-gray-300">Relationships: ${relationships ? relationships.length : 0}</div>
                                <div class="text-gray-400">Primary keys: ${
                                  tableInfo.filter((t) =>
                                    t.columns.some((c) => c.pk)
                                  ).length
                                }</div>
                            </div>
                        </div>
                    </div>
                </div>
                `;

          schemaDiagram.innerHTML = diagramHTML;
        };

        const getTableColor = (tableName) => {
          // Deterministic color based on table name
          const hash = Array.from(tableName).reduce((a, c) => ((a << 5) - a) + c.charCodeAt(0), 0);
          const hue = Math.abs(hash) % 360;
          return `border-[hsl(${hue}deg,60%,55%)]`;
        };

        const getTableIconColor = (tableName) => {
          const hash = Array.from(tableName).reduce((a, c) => ((a << 5) - a) + c.charCodeAt(0), 0);
          const hue = Math.abs(hash) % 360;
          return `bg-[hsl(${hue}deg,60%,55%)]`;
        };

        const handleRunQuery = async () => {
          if (!db_connection || runQueryBtn.disabled) return;

          const userQuery = editor.getValue();
          if (userQuery.trim() === "") {
            resultsContainer.innerHTML = `<p class="text-gray-500 text-sm">Editor is empty. Please enter a SQL query.</p>`;
            return;
          }

          runQueryBtn.disabled = true;
          resultsContainer.innerHTML = `<p class="text-yellow-400 text-sm">Executing query...</p>`;

          try {
            const resultArrow = await db_connection.query(userQuery);
            const results = resultArrow.toArray().map((row) => row.toJSON());

            if (resultArrow.numRows > 0) {
              renderTable(results, resultsContainer);
            } else {
              resultsContainer.innerHTML = `<div class="p-3 text-sm text-green-400 bg-green-900 rounded-md"><strong>Success!</strong> Query executed with no errors.</div>`;
            }
          } catch (e) {
            resultsContainer.innerHTML = `<div class="p-3 text-sm text-red-400 bg-red-900 rounded-md"><strong>Error:</strong> ${e.message}</div>`;
          } finally {
            runQueryBtn.disabled = false;
            await updateSchemaViewer();
            if (window.innerWidth <= 768) {
              showMobilePlaygroundView("output");
            }
          }
        };

        runQueryBtn.addEventListener("click", handleRunQuery);
        editor.setOption("extraKeys", {
          "Ctrl-Enter": handleRunQuery,
          "Cmd-Enter": handleRunQuery,
        });

  const headerTabs = document.querySelectorAll(".header-tab");
        const mobileNavButtons = document.querySelectorAll(".mobile-nav-btn");
  const examplesMain = document.getElementById("examples-main");
  const tmplGettingStarted = document.getElementById("tmpl-getting-started");
  const tmplUnderstanding = document.getElementById("tmpl-understanding-db");
  const tmplSqlRef = document.getElementById("tmpl-sql-reference");
  const tmplLessons = document.getElementById("tmpl-lessons");
  const examplesPrimaryNav = document.getElementById("examples-primary-nav");
  let lessonsCache = null; // cache lessons once fetched
  const lessonsHint = document.getElementById("lessons-hint");
  const lessonContent = document.getElementById("lesson-content");
  const lessonNavGroups = document.getElementById("lesson-nav-groups");

        const showMainView = (viewName) => {
          playgroundView.style.display =
            viewName === "playground" ? "flex" : "none";
          examplesView.style.display =
            viewName === "examples" ? "flex" : "none";

          headerTabs.forEach((tab) => {
            const isActive = tab.dataset.view === viewName;
            tab.classList.toggle("active", isActive);
            tab.classList.toggle("text-gray-400", !isActive);
            tab.classList.toggle("border-transparent", !isActive);
          });

          mobileNavButtons.forEach((btn) => {
            if (btn.dataset.view === "examples") {
              btn.classList.toggle("active", viewName === "examples");
            }
          });

          if (viewName === "playground") {
            setTimeout(() => editor.refresh(), 1);
          }
        };

        const showMobilePlaygroundView = (viewName) => {
          leftPanel.style.display = viewName === "editor" ? "flex" : "none";

          if (viewName === "output") {
            rightPanel.style.display = "flex";
            // Ensure results are shown in mobile output view
            schemaContent.classList.add("hidden");
            visualizationContent.classList.add("hidden");
            outputContent.classList.remove("hidden");
          } else if (viewName === "schema") {
            rightPanel.style.display = "flex";
            // Show schema content in fullscreen mobile mode
            schemaContent.classList.remove("hidden");
            visualizationContent.classList.add("hidden");
            outputContent.classList.add("hidden");
          } else if (viewName === "visualization") {
            rightPanel.style.display = "flex";
            // Show visualization content in fullscreen mobile mode
            schemaContent.style.display = "block";
            visualizationContent.style.display = "block";
            outputContent.classList.add("hidden");

            // Make schema/viz area take full height on mobile
            schemaContent.style.height = "calc(100vh - 200px)";
            visualizationContent.style.height = "calc(100vh - 200px)";
          } else {
            rightPanel.style.display = "none";
          }

          mobileNavButtons.forEach((btn) => {
            if (
              btn.dataset.view === "editor" ||
              btn.dataset.view === "output" ||
              btn.dataset.view === "schema" ||
              btn.dataset.view === "visualization"
            ) {
              btn.classList.toggle("active", btn.dataset.view === viewName);
            }
          });

          if (viewName === "editor") {
            setTimeout(() => editor.refresh(), 1);
          }
        };

        const handleViewChange = (view) => {
          if (
            view === "editor" ||
            view === "output" ||
            view === "visualization" ||
            view === "schema"
          ) {
            showMainView("playground");
            showMobilePlaygroundView(view);
          } else if (view === "examples") {
            showMainView("examples");
          } else if (view === "playground") {
            showMainView("playground");
            showMobilePlaygroundView("editor");
          }
        };

        headerTabs.forEach((tab) =>
          tab.addEventListener("click", () =>
            handleViewChange(tab.dataset.view)
          )
        );
        mobileNavButtons.forEach((btn) =>
          btn.addEventListener("click", () =>
            handleViewChange(btn.dataset.view)
          )
        );

        const resizer = document.getElementById("resizer");
        resizer.addEventListener("mousedown", (e) => {
          e.preventDefault();
          document.addEventListener("mousemove", handleMouseMove);
          document.addEventListener("mouseup", () => {
            document.removeEventListener("mousemove", handleMouseMove);
            editor.refresh();
          });
        });

        const handleMouseMove = (e) => {
          const totalWidth = playgroundView.offsetWidth;
          const newLeftWidth = (e.clientX / totalWidth) * 100;
          if (newLeftWidth > 20 && newLeftWidth < 80) {
            leftPanel.style.width = `${newLeftWidth}%`;
            rightPanel.style.width = `${100 - newLeftWidth}%`;
          }
        };

        const checkLayout = () => {
          if (window.innerWidth <= 768) {
            const currentPlaygroundView = document
              .querySelector('.mobile-nav-btn[data-view="editor"]')
              .classList.contains("active")
              ? "editor"
              : document
                  .querySelector('.mobile-nav-btn[data-view="output"]')
                  .classList.contains("active")
              ? "output"
              : document
                  .querySelector('.mobile-nav-btn[data-view="visualization"]')
                  .classList.contains("active")
              ? "visualization"
              : "editor";
            const currentMainViewIsPlayground =
              playgroundView.style.display !== "none";
            if (currentMainViewIsPlayground)
              showMobilePlaygroundView(currentPlaygroundView);
          } else {
            showMainView(
              document.querySelector(".header-tab.active")?.dataset.view ||
                "playground"
            );
            leftPanel.style.display = "flex";
            rightPanel.style.display = "flex";

            // Reset mobile-specific styles
            schemaContent.style.height = "";
            visualizationContent.style.height = "";
          }
        };

        window.addEventListener("resize", checkLayout);

        await updateSchemaViewer();
        checkLayout();
        hljs.highlightAll();

        // Examples single-container router
        const renderExamplesSection = (key) => {
          examplesMain.innerHTML = "";
          let tpl;
          if (key === "getting-started") tpl = tmplGettingStarted;
          else if (key === "understanding-db") tpl = tmplUnderstanding;
          else if (key === "sql-reference") tpl = tmplSqlRef;
          else if (key === "lessons") tpl = tmplLessons;
          else tpl = tmplGettingStarted;
          if (tpl && "content" in tpl) {
            examplesMain.appendChild(tpl.content.cloneNode(true));
          }
          // If lessons pane is active, ensure lesson-content hooks exist before loading
          if (key === "lessons") {
            // no-op here; loadLessons will target #lesson-content
          }
          // Update active style
          document.querySelectorAll('.ex-nav-btn').forEach((btn) => {
            btn.classList.toggle('text-gray-200', btn.dataset.section === key);
            btn.classList.toggle('text-gray-300', btn.dataset.section !== key);
            btn.classList.toggle('bg-gray-700', btn.dataset.section === key);
          });
        };

        // Sidebar primary nav handlers
        if (examplesPrimaryNav) {
          examplesPrimaryNav.addEventListener('click', (e) => {
            const btn = e.target.closest('.ex-nav-btn');
            if (!btn) return;
            const section = btn.getAttribute('data-section');
            renderExamplesSection(section);
            // Lazy-load lessons JSON only when Lessons view is opened
            if (section === 'lessons') {
              loadLessons().catch((e) => console.warn('Lessons load failed:', e));
            }
          });
        }

        // Copy example functionality
        const copyButtons = document.querySelectorAll(".copy-example");
        copyButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const example = button.dataset.example;
            if (example) {
              editor.setValue(example);
              editor.focus();

              // Visual feedback
              button.classList.add("copied");
              setTimeout(() => {
                button.classList.remove("copied");
              }, 2000);

              // Switch to playground view on mobile
              if (window.innerWidth <= 768) {
                showMainView("playground");
                showMobilePlaygroundView("editor");
              } else {
                showMainView("playground");
              }
            }
          });
        });

        // Schema tab functionality
        const schemaTabs = document.querySelectorAll(".schema-tab");
        schemaTabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            const isSchemaTab = tab.id === "schema-tab";
            const isVisualizationTab = tab.id === "visualization-tab";
            const isOutputTab = tab.id === "output-tab";

            // Update tab appearance
            schemaTabs.forEach((t) => {
              t.classList.remove("active", "border-blue-500", "text-blue-400");
              t.classList.add("border-transparent", "text-gray-400");
            });
            tab.classList.add("active", "border-blue-500", "text-blue-400");
            tab.classList.remove("border-transparent", "text-gray-400");

            // Show/hide content
            if (isSchemaTab) {
              schemaContent.classList.remove("hidden");
              visualizationContent.classList.add("hidden");
              outputContent.classList.add("hidden");
            } else if (isVisualizationTab) {
              schemaContent.classList.add("hidden");
              visualizationContent.classList.remove("hidden");
              outputContent.classList.add("hidden");
            } else if (isOutputTab) {
              schemaContent.classList.add("hidden");
              visualizationContent.classList.add("hidden");
              outputContent.classList.remove("hidden");
            }
          });
        });

        // ---- Lessons rendering (from examples/*.json) ----
  const lessonsSidenavList = document.getElementById("examples-sidenav-list");

        // Pedagogical ordering from fundamentals → joins → grouping → window → advanced
        const lessonFiles = [
          "db.json",                // what is a DB
          "ddl.json",               // create/alter objects
          "constraints.json",       // constraints
          "constraints_comparison.json",
          "altertable.json",        // schema evolution
          "dropncleanup.json",      // cleanup patterns
          "dcl.json",               // control (light)
          "tcl.json",               // transactions (light)
          "objects.json",           // objects overview
          "select.json",            // select basics
          "where.json",             // filtering
          "condition.json",         // case/conditions
          "orderbynlimit.json",     // sorting/limiting
          "agg.json",               // aggregation
          "set.json",               // set operations
          "cte.json",               // CTEs
          "joins.json",             // joins
          "views.json",             // views/materialization
          "window.json",            // window functions
          "subquery.json",          // subqueries
          "indexes.json",           // indexing/layout
          "string.json",            // string ops
          "datentime.json",         // date/time
          "duckadv.json",           // duckdb advanced
          "examples.json",          // roadmap/examples index
          "help.json"               // help
        ].map((f) => `examples/${f}`);

        const escapeHtml = (str) =>
          String(str || "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");

        const renderCompat = (compat) => {
          if (!compat || Object.keys(compat).length === 0) return "";
          const keys = Object.keys(compat);
          const first = keys[0];
          const tabs = keys
            .map((k, idx) => `<button class="compat-tab px-2 py-1 text-xs rounded ${idx===0?"bg-gray-700 text-white":"text-gray-300 hover:text-white"}" data-key="${escapeHtml(k)}">${escapeHtml(k)}</button>`)
            .join(" ");
          const panels = keys
            .map((k, idx) => {
              const content = escapeHtml(String(compat[k] || ""));
              return `<div class="compat-panel ${idx===0?"":"hidden"}" data-key="${escapeHtml(k)}">
                        <pre class="rounded bg-[#1f2937] p-3 overflow-auto text-xs"><code class="language-sql">${content}</code></pre>
                      </div>`;
            })
            .join("");
          return `<div class="mt-2 border border-gray-700 rounded">
            <div class="flex gap-2 p-2 bg-gray-800 border-b border-gray-700">${tabs}</div>
            <div class="p-2">${panels}</div>
          </div>`;
        };

  const renderLessonMain = (lesson) => {
          const title = escapeHtml(lesson.title || "Untitled Lesson");
          const description = escapeHtml(lesson.description || "");
          const narrativeTop = escapeHtml(lesson.narrative || "");
          const nerdTop = escapeHtml(lesson.nerd_notes || "");
          const sections = Array.isArray(lesson.sections) ? lesson.sections : [];
          const lessonCompat = renderCompat(lesson.compat_examples);
          const topExamples = Array.isArray(lesson.examples) ? lesson.examples : [];
          const topExamplesHtml = topExamples.length
            ? `<div class="space-y-3">${topExamples
                .map((ex) => {
                  const name = escapeHtml(ex.name || "Example");
                  const desc = escapeHtml(ex.description || "");
                  const sql = ex.sql || "";
                  const nerd = escapeHtml(ex.nerd_notes || "");
                  const compat = ex.compat_examples || lesson.compat_examples;
                  const compatHtml = renderCompat(compat);
                  const sqlEsc = escapeHtml(sql);
                  const copyData = sql.replace(/`/g, "\\`");
                  return `
                    <div class=\"bg-gray-800 rounded-md border border-gray-700 p-4 space-y-3\">
                      <div class=\"flex items-start justify-between gap-4\">
                        <div>
                          <h5 class=\"font-semibold text-gray-100 text-base\">${name}</h5>
                          ${desc ? `<p class=\"text-sm text-gray-300 mt-1\">${desc}</p>` : ""}
                        </div>
                        <div class=\"flex items-center gap-2 shrink-0\">
                          <button class=\"copy-example bg-green-700 hover:bg-green-600 text-white text-sm px-3 py-1 rounded\" data-example-sql=\"${encodeURIComponent(copyData)}\">Copy</button>
                        </div>
                      </div>
                      ${sql ? `<pre class=\"rounded bg-[#1f2937] p-4 overflow-auto text-sm\"><code class=\"language-sql\">${sqlEsc}</code></pre>` : ""}
                      ${compatHtml}
                      ${nerd ? `<div class=\"text-sm text-gray-300\"><span class=\"text-gray-200 font-semibold\">Notes:</span> ${nerd}</div>` : ""}
                    </div>`;
                })
                .join("")}</div>`
            : "";

          const sectionHtml = sections
            .map((section, idx) => {
              const stitle = escapeHtml(section.title || `Section ${idx + 1}`);
              const sdesc = escapeHtml(section.description || "");
              const snarr = escapeHtml(section.narrative || "");
              const snerd = escapeHtml(section.nerd_notes || "");
              const scompat = section.compat_examples;
              const sCompatHtml = renderCompat(scompat);
              const examples = Array.isArray(section.examples)
                ? section.examples
                : [];

              const examplesHtml = examples
                .map((ex) => {
                  const name = escapeHtml(ex.name || "Example");
                  const desc = escapeHtml(ex.description || "");
                  const sql = ex.sql || "";
                  const nerd = escapeHtml(ex.nerd_notes || "");
                  const compat = ex.compat_examples || section.compat_examples || lesson.compat_examples;
                  const compatHtml = renderCompat(compat);
                  const sqlEsc = escapeHtml(sql);
                  const copyData = sql.replace(/`/g, "\\`");
                  return `
                    <div class="bg-gray-800 rounded-md border border-gray-700 p-4 space-y-3">
                      <div class="flex items-start justify-between gap-4">
                        <div>
                          <h5 class="font-semibold text-gray-100 text-base">${name}</h5>
                          ${desc ? `<p class="text-sm text-gray-300 mt-1">${desc}</p>` : ""}
                        </div>
                        <div class="flex items-center gap-2 shrink-0">
                          <button class="copy-example bg-green-700 hover:bg-green-600 text-white text-sm px-3 py-1 rounded" data-example-sql="${encodeURIComponent(copyData)}">Copy</button>
                        </div>
                      </div>
                      ${sql ? `<pre class="rounded bg-[#1f2937] p-4 overflow-auto text-sm"><code class="language-sql">${sqlEsc}</code></pre>` : ""}
                      ${compatHtml}
                      ${nerd ? `<div class="text-sm text-gray-300"><span class="text-gray-200 font-semibold">Notes:</span> ${nerd}</div>` : ""}
                    </div>`;
                })
                .join("");

              return `
                <div class="space-y-3">
                  <h4 class="text-xl font-semibold text-teal-300">${stitle}</h4>
                  ${sdesc ? `<p class="text-gray-300 text-base">${sdesc}</p>` : ""}
                  ${snarr ? `<p class="text-gray-300 text-base">${snarr}</p>` : ""}
                  ${sCompatHtml}
                  ${snerd ? `<div class="text-sm text-gray-400">${snerd}</div>` : ""}
                  <div class="space-y-3">${examplesHtml}</div>
                </div>`;
            })
            .join("<hr class=\"border-gray-700\" />");

          // Exercises support
          const exercises = Array.isArray(lesson.exercises) ? lesson.exercises : [];
          const exercisesHtml = exercises.length
            ? `
              <div class="mt-6">
                <h4 class="text-xl font-semibold text-orange-300">Exercises</h4>
                <div class="space-y-3 mt-2">
                  ${exercises
                    .map((ex) => {
                      const exId = escapeHtml(ex.id || "exercise");
                      const prompt = escapeHtml(ex.prompt || "");
                      const answer = ex.answer_sql || "";
                      const answerEsc = escapeHtml(answer);
                      const copyData = answer.replace(/`/g, "\\`");
                      return `
                        <div class="bg-gray-800 border border-gray-700 rounded p-3">
                          <div class="flex items-start justify-between gap-3">
                            <div>
                              <div class="text-gray-200 font-medium">${exId}</div>
                              <div class="text-gray-300 text-base">${prompt}</div>
                            </div>
                            <div class="flex gap-2">
                              <button class="copy-example bg-green-700 hover:bg-green-600 text-white text-sm px-3 py-1 rounded" data-example-sql="${encodeURIComponent(copyData)}">Copy Answer</button>
                              <button class="toggle-answer bg-gray-700 hover:bg-gray-600 text-white text-sm px-3 py-1 rounded" data-target="ans-${exId}">Show</button>
                            </div>
                          </div>
                          ${answer ? `<div id="ans-${exId}" class="mt-2 hidden"><pre class="rounded bg-[#1f2937] p-3 overflow-auto text-sm"><code class="language-sql">${answerEsc}</code></pre></div>` : ""}
                        </div>`;
                    })
                    .join("")}
                </div>
              </div>`
            : "";

          return `
            <div class="space-y-4">
              <div>
                <h3 class="text-3xl font-semibold text-gray-100">${title}</h3>
                ${description ? `<p class=\"text-base text-gray-300 mt-1\">${description}</p>` : ""}
                ${narrativeTop ? `<p class=\"text-base text-gray-300 mt-1\">${narrativeTop}</p>` : ""}
                ${nerdTop ? `<div class=\"text-sm text-gray-400 mt-1\">${nerdTop}</div>` : ""}
                ${lessonCompat}
              </div>
              ${topExamplesHtml}
              <div class="space-y-6">${sectionHtml || '<p class=\"text-gray-300 text-base\">No sections.</p>'}</div>
              ${exercisesHtml}
            </div>`;
        };

        // Shared helpers to render a lesson from cache and set active state
        const setLessonActive = (idx) => {
          if (!lessonNavGroups) return;
          lessonNavGroups.querySelectorAll('.lesson-nav-item').forEach((el) => {
            el.classList.toggle('bg-gray-700', Number(el.getAttribute('data-index')) === idx);
            el.classList.toggle('border-l-2', Number(el.getAttribute('data-index')) === idx);
            el.classList.toggle('border-green-500', Number(el.getAttribute('data-index')) === idx);
          });
        };

        const renderLessonAtIndex = (idx) => {
          const lc = document.getElementById('lesson-content');
          if (!lc || !Array.isArray(lessonsCache) || !lessonsCache[idx]) return false;
          lc.innerHTML = renderLessonMain(lessonsCache[idx].data);
          lc.querySelectorAll('pre code').forEach((el) => { try { hljs.highlightElement(el); } catch (_) {} });
          setLessonActive(idx);
          return true;
        };

        const loadLessons = async () => {
          // Use cache if available to avoid refetch
          if (Array.isArray(lessonsCache) && lessonsCache.length > 0) {
            // If the lessons view is active now, just (re)bind into its container
            const lessonContentEl0 = document.getElementById('lesson-content');
            if (lessonContentEl0 && !lessonContentEl0.dataset.bound) {
              // Re-render first lesson and bind events using cached data
              // Global nav delegation (one-time) will handle nav clicks
              // Events in content
              lessonContentEl0.addEventListener('click', (e) => {
                const copyBtn = e.target.closest('.copy-example');
                if (copyBtn) {
                  const sqlEncoded = copyBtn.getAttribute('data-example-sql') || '';
                  try { const sql = decodeURIComponent(sqlEncoded); editor.setValue(sql); editor.focus(); } catch {}
                }
              });
              // Render first lesson
              renderLessonAtIndex(0);
              lessonContentEl0.dataset.bound = '1';
            }
            return lessonsCache;
          }
          // Resolve lesson DOM now that Lessons template may be rendered
          const lessonContentEl = document.getElementById('lesson-content');
          const lessonsHintEl = document.getElementById('lessons-hint');
          if (!lessonContentEl) {
            console.warn('Lessons container not found; ensure Lessons view is active before loading.');
          }
          const lessons = [];
          for (const path of lessonFiles) {
            try {
              const res = await fetch(path);
              if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
              const json = await res.json();
              lessons.push({ path, data: json });
            } catch (e) {
              console.warn("Failed to load lesson:", path, e);
            }
          }
          lessonsCache = lessons;

          if (lessons.length === 0) {
            const msg = `<div class=\"p-3 text-base text-yellow-300\">Unable to load lessons. If you opened this file directly from disk, please serve the folder via a local HTTP server.</div>`;
            if (lessonContentEl) lessonContentEl.innerHTML = msg;
            if (lessonsHintEl) lessonsHintEl.classList.remove('hidden');
            return;
          }

          // Render global sidenav groups with collapsible sections
          lessonNavGroups.innerHTML = lessons
            .map((l, i) => {
              const title = escapeHtml(l.data.title || l.path.replace(/^.*\//, ''));
              const sections = Array.isArray(l.data.sections) ? l.data.sections : [];
              const sectHtml = sections
                .map((s, si) => {
                  const st = escapeHtml(s.title || `Section ${si+1}`);
                  return `<button class="lesson-nav-section block w-full text-left text-xs px-3 py-1.5 text-gray-300 hover:text-white" data-index="${i}" data-section="${si}">• ${st}</button>`;
                })
                .join("");
              return `
                <div class="border border-gray-700 rounded">
                  <button class="lesson-nav-item w-full text-left px-3 py-2 text-sm hover:bg-gray-700 focus:bg-gray-700 focus:outline-none flex items-center justify-between" data-index="${i}">
                    <span class="text-gray-200">${title}</span>
                    <span class="chev text-gray-400">▾</span>
                  </button>
                  <div class="lesson-nav-sections hidden py-1">${sectHtml || '<div class="px-3 py-2 text-xs text-gray-500">No sections</div>'}</div>
                </div>`;
            })
            .join("");

          // Render first by default (if the Lessons view is present)
          if (lessonContentEl) renderLessonAtIndex(0);

          // Copy to editor (event delegation) from main content + toggle answer
          if (lessonContentEl) lessonContentEl.addEventListener('click', (e) => {
            const copyBtn = e.target.closest('.copy-example');
            if (copyBtn) {
              const sqlEncoded = copyBtn.getAttribute('data-example-sql') || '';
              try {
                const sql = decodeURIComponent(sqlEncoded);
                editor.setValue(sql);
                editor.focus();
                copyBtn.classList.add('ring-2','ring-green-400');
                setTimeout(() => copyBtn.classList.remove('ring-2','ring-green-400'), 800);
                if (window.innerWidth <= 768) {
                  showMainView('playground');
                  showMobilePlaygroundView('editor');
                } else {
                  showMainView('playground');
                }
              } catch (err) {
                console.error('Failed to copy example', err);
              }
              return;
            }
            const toggle = e.target.closest('.toggle-answer');
            if (toggle) {
              const id = toggle.getAttribute('data-target');
              const panel = id ? document.getElementById(id) : null;
              if (panel) {
                panel.classList.toggle('hidden');
                toggle.textContent = panel.classList.contains('hidden') ? 'Show' : 'Hide';
                if (!panel.classList.contains('hidden')) {
                  // highlight on first show
                  const code = panel.querySelector('pre code');
                  if (code && !panel.dataset.hl) {
                    try { hljs.highlightElement(code); } catch (_) {}
                    panel.dataset.hl = '1';
                  }
                }
              }
            }
          });

          // Compat tabs interaction (event delegation)
          if (lessonContentEl) lessonContentEl.addEventListener('click', (e) => {
            const tab = e.target.closest('.compat-tab');
            if (!tab) return;
            const key = tab.getAttribute('data-key');
            const wrapper = tab.closest('.border');
            if (!wrapper) return;
            // update tab styles
            wrapper.querySelectorAll('.compat-tab').forEach((t) => {
              t.classList.remove('bg-gray-700','text-white');
              t.classList.add('text-gray-300');
            });
            tab.classList.add('bg-gray-700','text-white');
            tab.classList.remove('text-gray-300');
            // switch panels
            wrapper.querySelectorAll('.compat-panel').forEach((p) => {
              p.classList.toggle('hidden', p.getAttribute('data-key') !== key);
            });
          });
        };

        // One-time global delegation: clicking items in lesson sidenav switches to Lessons and renders
        if (lessonNavGroups && !lessonNavGroups.dataset.bound) {
          lessonNavGroups.addEventListener('click', async (e) => {
            const item = e.target.closest('.lesson-nav-item');
            const sect = e.target.closest('.lesson-nav-section');
            if (!item && !sect) return;
            e.preventDefault();

            // ensure sections dropdown toggles when clicking item
            if (item) {
              const container = item.parentElement?.querySelector?.('.lesson-nav-sections');
              if (container) container.classList.toggle('hidden');
            }

            const idx = Number((item || sect).getAttribute('data-index'));
            const sectionIdx = sect ? Number(sect.getAttribute('data-section')) : null;

            // Ensure Lessons main view is visible
            if (!document.getElementById('lesson-content')) {
              renderExamplesSection('lessons');
              await loadLessons();
            }
            // Render selected lesson and optionally scroll to section
            const ok = renderLessonAtIndex(isNaN(idx) ? 0 : idx);
            if (ok && sectionIdx != null) {
              const targets = document.querySelectorAll('#lesson-content h4.text-xl');
              const tgt = targets[sectionIdx];
              if (tgt) tgt.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          }, { capture: false });
          lessonNavGroups.dataset.bound = '1';
        }

  // Initially show Getting Started and preload lessons ASAP
  renderExamplesSection('getting-started');
  loadLessons().catch((e) => console.warn('Preload lessons failed:', e));
      });
    </script>
  </body>
</html>
